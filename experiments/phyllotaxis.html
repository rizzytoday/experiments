<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phyllotaxis Engine</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0804; overflow: hidden; cursor: crosshair; }
canvas { display: block; }
.controls {
  position: fixed; bottom: 16px; right: 16px;
  background: rgba(30,24,16,0.75); backdrop-filter: blur(20px);
  border: 1px solid rgba(252,225,132,0.12); border-radius: 14px;
  padding: 14px 18px; font: 11px/1.6 monospace; color: rgba(252,225,132,0.55);
  min-width: 220px; z-index: 10;
  box-shadow: 0 4px 24px rgba(0,0,0,0.3);
}
.controls label { display: flex; justify-content: space-between; align-items: center; margin: 4px 0; }
.controls span { min-width: 50px; text-align: right; color: rgba(252,225,132,0.8); }
input[type=range] {
  -webkit-appearance: none; width: 90px; height: 3px; background: rgba(252,225,132,0.15);
  border-radius: 2px; outline: none; margin: 0 8px;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none; width: 12px; height: 12px;
  background: #FCE184; border-radius: 50%; cursor: pointer;
}
.hint { color: rgba(252,225,132,0.25); margin-top: 8px; font-size: 10px; line-height: 1.5; }
</style>
</head>
<body>
<canvas id="c"></canvas>
<div class="controls">
  <label>angle <input type="range" id="angle" min="130" max="145" step="0.01" value="137.51"> <span id="angleV">137.51°</span></label>
  <label>dots <input type="range" id="dots" min="200" max="5000" step="50" value="2500"> <span id="dotsV">2500</span></label>
  <label>size <input type="range" id="size" min="0.5" max="4" step="0.1" value="2.5"> <span id="sizeV">2.5</span></label>
  <label>speed <input type="range" id="aspeed" min="0" max="2" step="0.05" value="0.5"> <span id="aspeedV">0.5</span></label>
  <label>palette <input type="range" id="palette" min="0" max="4" step="1" value="0"> <span id="paletteV">gold</span></label>
  <label>spin <input type="range" id="spin" min="0" max="0.5" step="0.01" value="0"> <span id="spinV">0.00</span></label>
  <div class="hint">hover: highlight spiral arm · click: pause<br>auto-oscillates around slider angle</div>
</div>
<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');

let numDots = 2500;
let baseAngle = 137.51;
let dotSize = 2.5;
let oscSpeed = 0.5;
let paletteIdx = 0;
let spinSpeed = 0;
let autoTime = 0, lastT = 0;
let paused = false;
let mouseX = -1, mouseY = -1;
let hoverN = -1;

const angleEl = document.getElementById('angle');
const dotsEl = document.getElementById('dots');
const sizeEl = document.getElementById('size');
const aspeedEl = document.getElementById('aspeed');
const paletteEl = document.getElementById('palette');
const spinEl = document.getElementById('spin');

const paletteNames = ['gold', 'ember', 'ice', 'forest', 'violet'];

angleEl.oninput = () => { baseAngle = +angleEl.value; document.getElementById('angleV').textContent = baseAngle.toFixed(2) + '°'; };
dotsEl.oninput = () => { numDots = +dotsEl.value; document.getElementById('dotsV').textContent = numDots; };
sizeEl.oninput = () => { dotSize = +sizeEl.value; document.getElementById('sizeV').textContent = dotSize.toFixed(1); };
aspeedEl.oninput = () => { oscSpeed = +aspeedEl.value; document.getElementById('aspeedV').textContent = oscSpeed.toFixed(2); };
paletteEl.oninput = () => { paletteIdx = +paletteEl.value; document.getElementById('paletteV').textContent = paletteNames[paletteIdx]; };
spinEl.oninput = () => { spinSpeed = +spinEl.value; document.getElementById('spinV').textContent = spinSpeed.toFixed(2); };

function resize() {
  const dpr = window.devicePixelRatio || 1;
  canvas.width = window.innerWidth * dpr;
  canvas.height = window.innerHeight * dpr;
  canvas.style.width = window.innerWidth + 'px';
  canvas.style.height = window.innerHeight + 'px';
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}
resize();
window.addEventListener('resize', resize);

canvas.addEventListener('mousemove', (e) => { mouseX = e.clientX; mouseY = e.clientY; });
canvas.addEventListener('mouseleave', () => { mouseX = -1; mouseY = -1; hoverN = -1; });
canvas.addEventListener('click', () => { paused = !paused; });

// Color palettes
const palettes = [
  // Gold
  (n, total, hl) => {
    const t = n / total;
    return [180 + 75*t, 120 + 100*t*(1-t*0.5), 20 + 40*t, hl ? 1 : 0.85];
  },
  // Ember
  (n, total, hl) => {
    const t = n / total;
    return [200 + 55*t, 50 + 80*t*(1-t), 10 + 20*t, hl ? 1 : 0.8];
  },
  // Ice
  (n, total, hl) => {
    const t = n / total;
    return [100 + 80*t, 160 + 80*t, 200 + 55*t, hl ? 1 : 0.85];
  },
  // Forest
  (n, total, hl) => {
    const t = n / total;
    return [40 + 60*t, 140 + 100*t*(1-t*0.3), 50 + 70*t, hl ? 1 : 0.82];
  },
  // Violet
  (n, total, hl) => {
    const t = n / total;
    return [140 + 80*t, 60 + 60*t, 180 + 70*t*(1-t*0.4), hl ? 1 : 0.85];
  },
];

const bgColors = ['#0a0804', '#0c0404', '#040810', '#040a06', '#08040c'];

function dotColor(n, total, highlighted) {
  const [r, g, b, a] = palettes[paletteIdx](n, total, highlighted);
  return `rgba(${Math.floor(r)},${Math.floor(g)},${Math.floor(b)},${a})`;
}

function draw(t) {
  const dt = (t - lastT) * 0.001; lastT = t;
  if (!paused) autoTime += dt;

  const w = window.innerWidth, h = window.innerHeight;
  ctx.fillStyle = bgColors[paletteIdx];
  ctx.fillRect(0, 0, w, h);

  const centerX = w / 2, centerY = h / 2;
  const maxRadius = Math.min(w, h) * 0.45;

  // Oscillate around the slider's base angle
  const osc = Math.sin(autoTime * 0.105 * (oscSpeed / 0.5));
  const divergenceDeg = baseAngle + osc * 0.8 * oscSpeed;
  const divergenceAngle = divergenceDeg * (Math.PI / 180);
  const scale = maxRadius / Math.sqrt(numDots);

  // Find nearest dot to mouse
  let nearestDist = Infinity;
  hoverN = -1;
  const positions = [];

  // Global rotation
  const globalRot = autoTime * spinSpeed;

  for (let n = 1; n <= numDots; n++) {
    const r = scale * Math.sqrt(n);
    const theta = n * divergenceAngle + globalRot;
    const x = centerX + r * Math.cos(theta);
    const y = centerY + r * Math.sin(theta);
    positions.push({ x, y });

    if (mouseX >= 0) {
      const dx = mouseX - x, dy = mouseY - y;
      const d = dx * dx + dy * dy;
      if (d < nearestDist && d < 900) { nearestDist = d; hoverN = n; }
    }
  }

  // Draw dots – highlight spiral arm containing hovered dot
  // Spiral arm: dots at hoverN ± multiples of common Fibonacci numbers
  const fibNums = [5, 8, 13, 21, 34, 55];
  let highlightSet = new Set();
  if (hoverN > 0) {
    highlightSet.add(hoverN);
    for (const fib of fibNums) {
      for (let k = hoverN % fib; k <= numDots; k += fib) {
        if (k > 0) highlightSet.add(k);
      }
    }
  }

  // Subtle glow behind – color-matched
  if (hoverN < 0) {
    const glowColors = ['252,225,132', '255,120,60', '140,200,255', '120,220,140', '180,120,255'];
    const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, maxRadius * 0.3);
    gradient.addColorStop(0, `rgba(${glowColors[paletteIdx]},0.04)`);
    gradient.addColorStop(1, `rgba(${glowColors[paletteIdx]},0)`);
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, w, h);
  }

  for (let n = 1; n <= numDots; n++) {
    const { x, y } = positions[n - 1];
    const isHL = highlightSet.has(n);
    const dimmed = hoverN > 0 && !isHL;

    let r = Math.max(0.8, dotSize - (n / numDots) * (dotSize * 0.5));
    if (isHL) r *= 1.3;

    if (dimmed) {
      const dimColors = ['rgba(100,80,40,0.15)', 'rgba(100,40,30,0.12)', 'rgba(40,60,80,0.12)', 'rgba(40,70,40,0.12)', 'rgba(60,30,70,0.12)'];
      ctx.fillStyle = dimColors[paletteIdx];
    } else {
      ctx.fillStyle = dotColor(n, numDots, isHL);
    }

    ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.fill();
  }

  // Angle readout
  const goldenAngle = 137.5077;
  const diff = divergenceDeg - goldenAngle;
  const readoutColors = ['rgba(252,225,132,0.25)', 'rgba(255,120,60,0.25)', 'rgba(140,200,255,0.25)', 'rgba(120,220,140,0.25)', 'rgba(180,120,255,0.25)'];
  ctx.fillStyle = readoutColors[paletteIdx];
  ctx.font = '12px monospace'; ctx.textAlign = 'left';
  ctx.fillText(`θ = ${divergenceDeg.toFixed(3)}°  (φ ${diff >= 0 ? '+' : ''}${diff.toFixed(3)}°)`, 16, h - 16);

  requestAnimationFrame(draw);
}
requestAnimationFrame(draw);
</script>
</body>
</html>

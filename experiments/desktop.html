<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Desktop</title>
<link href="https://fonts.googleapis.com/css2?family=Fragment+Mono&family=Inter+Tight:wght@400;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#050505;overflow:hidden;width:100vw;height:100vh;cursor:none;font-family:'Inter Tight',system-ui,sans-serif}
#bg,#cn,#ol{position:fixed;inset:0;pointer-events:none}
#bg{z-index:0}#cn{z-index:0}#ol{z-index:9999}
#grid{position:relative;display:grid;grid-template-columns:repeat(4,1fr);grid-auto-rows:1fr;gap:6px;padding:6px;width:100vw;height:100vh;z-index:1}
.conn-canvas{position:fixed;inset:0;pointer-events:none;z-index:0}
.win{display:flex;flex-direction:column;background:rgba(12,12,12,.88);border:1px solid rgba(255,255,255,.06);border-radius:10px;overflow:hidden;backdrop-filter:blur(30px) saturate(120%);-webkit-backdrop-filter:blur(30px) saturate(120%);box-shadow:0 12px 40px rgba(0,0,0,.4);min-height:0;position:relative;transition:opacity .4s ease}
.win.expanded{grid-column:span 2;grid-row:span 2}
.win.dragging{opacity:.92;box-shadow:0 24px 60px rgba(0,0,0,.6);z-index:100;pointer-events:none}
.win.faded{opacity:0;pointer-events:none;position:absolute;width:0;height:0;overflow:hidden}
.win.solo{position:fixed;inset:0;z-index:50;border-radius:0;width:100vw;height:100vh}
.win.detached{position:fixed;z-index:80;border-radius:12px}
.win.mirrored .body canvas{transform-origin:center;scale:-1 1}
.ph{background:rgba(255,255,255,.01);border:1px dashed rgba(255,255,255,.05);border-radius:10px}
.ph.expanded{grid-column:span 2;grid-row:span 2}
.bar{display:flex;align-items:center;gap:6px;padding:6px 10px;background:rgba(255,255,255,.02);border-bottom:1px solid rgba(255,255,255,.04);user-select:none;cursor:grab;flex-shrink:0;height:30px}
.bar:active{cursor:grabbing}
.dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;will-change:transform}
.dot.r{background:#ff5f57}.dot.y{background:#febc2e}.dot.g{background:#28c840}
.ttl{font-family:'Fragment Mono',monospace;font-size:9px;color:rgba(255,255,255,.2);letter-spacing:.04em;margin-left:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.body{flex:1;overflow:hidden;min-height:0}
.body canvas{display:block;width:100%;height:100%}
.bbtn{background:none;border:none;color:rgba(255,255,255,.12);font-size:9px;cursor:pointer;padding:0 2px;line-height:1}
.bbtn:hover{color:rgba(255,255,255,.4)}
.bgrp{display:flex;gap:4px;margin-left:auto}
#clock{position:fixed;bottom:8px;right:12px;font-family:'Fragment Mono',monospace;font-size:9px;color:rgba(255,255,255,.08);z-index:2;pointer-events:none}
#lbl{position:fixed;bottom:8px;left:12px;font-family:'Fragment Mono',monospace;font-size:8px;color:rgba(255,255,255,.05);z-index:2;pointer-events:none}
#spd{position:fixed;bottom:8px;left:50%;transform:translateX(-50%);font-family:'Fragment Mono',monospace;font-size:8px;color:rgba(255,255,255,0);z-index:2;pointer-events:none;transition:color .3s}
#hint{position:fixed;bottom:10px;right:36px;width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,.04);z-index:9998;cursor:pointer;opacity:0;transition:opacity .5s}
#hint:hover{opacity:1;background:rgba(255,255,255,.15)}
#hint.visible{opacity:1}
#help{display:none;position:fixed;bottom:24px;right:12px;background:rgba(12,12,12,.92);backdrop-filter:blur(40px);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:12px 16px;font-family:'Fragment Mono',monospace;font-size:8px;color:rgba(255,255,255,.35);line-height:1.8;z-index:9998;white-space:pre}
#hint:hover ~ #help,#help:hover{display:block}
.conn{position:fixed;pointer-events:none;z-index:0}
@media(max-width:1200px){#grid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:800px){#grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:500px){#grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<canvas id="bg"></canvas>
<div id="grid"></div>
<canvas id="cn"></canvas>
<canvas id="ol"></canvas>
<div id="clock"></div>
<div id="lbl">// all generated by code</div>
<div id="spd"></div>
<div id="hint"></div>
<div id="help">space .......... pause / resume
1-9 ............ solo experiment
r .............. replay all
g .............. toggle grid
c .............. cycle colors
m .............. mirror mode
i .............. invert
x .............. chaos mode (5s)
shift+click .... clone window
alt+drag ....... detach window
shift+scroll ... time speed
tab ............ cycle focus
pinch .......... zoom window</div>
<script>
// ── globals ──
let mx=-1e3,my=-1e3,pMx=-1e3,pMy=-1e3,mSpd=0,mVx=0,mVy=0;
let clicking=false,shiftKey=false,altKey=false;
const dpr=devicePixelRatio||1;
const bgC=document.getElementById('bg'),bgX=bgC.getContext('2d');
const cnC=document.getElementById('cn'),cnX=cnC.getContext('2d');
const olC=document.getElementById('ol'),olX=olC.getContext('2d');
const grid=document.getElementById('grid');
const spdEl=document.getElementById('spd');
const hintEl=document.getElementById('hint');

// ── state ──
let paused=false,soloIdx=-1,showGrid=true,colorMode=0,mirrored=false,inverted=false;
let chaosMode=false,chaosEnd=0;
let timeScale=1,forceRadius=120,lastInteract=0;
let globalTime=0,prevT=0;

// ── reactive color ──
function getHue(offset){
  const baseHue=(globalTime*.006)%360;
  const cursorShift=(mx>-500)?(mx/innerWidth-.5)*80:0;
  return(baseHue+cursorShift+offset+360)%360;
}
function getCol(offset,alpha,sat,lit){
  if(colorMode===1)return `rgba(255,255,255,${alpha})`;
  if(colorMode===2)return `rgba(252,225,132,${alpha})`;
  const h=getHue(offset);
  const intensity=Math.min(1,mSpd/30);
  const s=sat!==undefined?sat:(35+intensity*35);
  const l=lit!==undefined?lit:(60+intensity*20);
  return `hsla(${h|0},${s|0}%,${l|0}%,${alpha})`;
}
function getBg(){return inverted?'rgba(245,245,240,1)':'rgba(5,5,5,1)'}
function getBgFade(a){return inverted?`rgba(245,245,240,${a})`:`rgba(5,5,5,${a})`}
function getStroke(){return inverted?'#111':'#fff'}

// ── resize ──
function resizeGlobal(){
  const W=innerWidth,H=innerHeight;
  [bgC,cnC,olC].forEach(c=>{c.width=W*dpr;c.height=H*dpr;c.style.width=W+'px';c.style.height=H+'px';c.getContext('2d').setTransform(dpr,0,0,dpr,0,0)});
  exps.forEach(e=>{if(e.cv)resizeCanvas(e)});
}
function resizeCanvas(e){
  const b=e.cv.parentElement;if(!b)return;
  const w=b.clientWidth,h=b.clientHeight;
  if(w<1||h<1)return;
  e.cv.width=w*dpr;e.cv.height=h*dpr;
  e.cv.style.width=w+'px';e.cv.style.height=h+'px';
  e.cx.setTransform(dpr,0,0,dpr,0,0);e.w=w;e.h=h;
}
addEventListener('resize',resizeGlobal);

// ── input ──
document.addEventListener('mousemove',e=>{
  pMx=mx;pMy=my;mx=e.clientX;my=e.clientY;
  mVx=mx-pMx;mVy=my-pMy;mSpd=Math.hypot(mVx,mVy);
  shiftKey=e.shiftKey;altKey=e.altKey;lastInteract=performance.now();
});
document.addEventListener('mousedown',e=>{clicking=true;shiftKey=e.shiftKey;altKey=e.altKey});
document.addEventListener('mouseup',()=>{clicking=false});
document.addEventListener('mouseleave',()=>{mx=-1e3;my=-1e3;mSpd=0;mVx=0;mVy=0;clicking=false});

// pinch-to-zoom + scroll force radius
document.addEventListener('wheel',e=>{
  if(shiftKey){
    // time dilation
    e.preventDefault();
    timeScale=Math.max(.25,Math.min(4,timeScale*(e.deltaY>0?.85:1.18)));
    spdEl.textContent=timeScale.toFixed(2)+'x';spdEl.style.color='rgba(255,255,255,.15)';
    setTimeout(()=>{spdEl.style.color='rgba(255,255,255,0)'},1200);
    return;
  }
  if(e.ctrlKey){
    // pinch-to-zoom on trackpad
    e.preventDefault();
    const hovExp=exps.find(x=>{if(!x.el||!x.cv)return false;const r=x.el.getBoundingClientRect();return mx>=r.left&&mx<=r.right&&my>=r.top&&my<=r.bottom});
    if(hovExp){
      hovExp.zoom=Math.max(.3,Math.min(3,hovExp.zoom-e.deltaY*.005));
    }
    return;
  }
  // adjust force radius
  forceRadius=Math.max(40,Math.min(300,forceRadius+(e.deltaY>0?-8:8)));
},{passive:false});

// ── local mouse helper ──
function getZoom(e){return e.zoom*(e.hov?1.02:1)}
function lm(e){
  const b=e.cv.parentElement,r=b.getBoundingClientRect();
  const z=getZoom(e);
  // virtual dimensions (bigger when zoomed out)
  const vw=e.w/z,vh=e.h/z;
  return{
    x:vw/2+(mx-r.left-r.width/2)/z,
    y:vh/2+(my-r.top-r.height/2)/z,
    in:mx>=r.left&&mx<=r.right&&my>=r.top&&my<=r.bottom,
    vx:mVx/z,vy:mVy/z,spd:mSpd,click:clicking,shift:shiftKey,r
  };
}

// ── physics force helper ──
function applyForce(px,py,m,radius){
  if(!m.in)return{fx:0,fy:0};
  const dx=px-m.x,dy=py-m.y,d=Math.sqrt(dx*dx+dy*dy);
  if(d>radius||d<1)return{fx:0,fy:0};
  const f=1-d/radius;
  let fx=0,fy=0;
  if(m.click&&!m.shift){
    // attractor
    fx=-(dx/d)*f*f*40;fy=-(dy/d)*f*f*40;
  }else if(m.click&&m.shift){
    // repulsor
    fx=(dx/d)*f*f*60;fy=(dy/d)*f*f*60;
  }else{
    // velocity wake + radial push
    fx=(dx/d)*f*15+m.vx*f*.4;
    fy=(dy/d)*f*15+m.vy*f*.4;
  }
  return{fx,fy};
}

// ── iso helper ──
const A30=Math.PI/6;
function isoF(ctx,pts,f,s){ctx.beginPath();ctx.moveTo(pts[0][0],pts[0][1]);for(let i=1;i<pts.length;i++)ctx.lineTo(pts[i][0],pts[i][1]);ctx.closePath();ctx.fillStyle=f;ctx.fill();ctx.strokeStyle=s;ctx.lineWidth=.6;ctx.stroke()}

// ── experiments ──
const PHI=(1+Math.sqrt(5))/2;

const exps=[
  {id:'butterfly',title:'butterfly_curve.js',hue:0,s:{trail:[],t:0},draw:drawButterfly,signal:0},
  {id:'golden',title:'golden_ratio.js',hue:40,s:{st:-1},draw:drawGolden,signal:0},
  {id:'cubes',title:'cube_array.js',hue:200,s:{},draw:drawCubes,signal:0},
  {id:'waves',title:'sine_field.js',hue:180,s:{},draw:drawWaves,signal:0},
  {id:'lorenz',title:'lorenz_attractor.js',hue:280,s:{x:.1,y:0,z:0,trail:[]},draw:drawLorenz,signal:0},
  {id:'rose',title:'rose_curves.js',hue:320,s:{st:-1},draw:drawRose,signal:0},
  {id:'pendulum',title:'pendulum_wave.js',hue:60,s:{},draw:drawPendulum,signal:0},
  {id:'lissajous',title:'lissajous.js',hue:140,s:{st:-1},draw:drawLissajous,signal:0},
  {id:'life',title:'game_of_life.js',hue:100,s:{grid:null,gen:0,tick:0},draw:drawLife,signal:0},
  {id:'boids',title:'flock.js',hue:220,s:{birds:null,food:null},draw:drawBoids,signal:0},
  {id:'galaxy',title:'galaxy.js',hue:260,s:{stars:null},draw:drawGalaxy,signal:0},
  {id:'ftree',title:'fractal_tree.js',hue:300,s:{st:-1},draw:drawFractalTree,signal:0},
  {id:'terrain',title:'perlin_terrain.js',hue:90,s:{offset:0,perm:null},draw:drawTerrain,signal:0},
  {id:'dpendulum',title:'double_pendulum.js',hue:15,s:{a1:Math.PI*.75,a2:Math.PI*.5,v1:0,v2:0,trail:[]},draw:drawDoublePendulum,signal:0},
];

// ── build DOM ──
exps.forEach((e,idx)=>{
  const w=document.createElement('div');w.className='win';w.dataset.id=e.id;w.dataset.idx=idx;
  w.innerHTML=`<div class="bar"><div class="dot r"></div><div class="dot y"></div><div class="dot g"></div><span class="ttl">${e.title}</span><span class="bgrp"><button class="bbtn sb">◻</button><button class="bbtn rb">↻</button></span></div><div class="body"><canvas></canvas></div>`;
  grid.appendChild(w);
  e.el=w;e.cv=w.querySelector('canvas');e.cx=e.cv.getContext('2d');e.zoom=1;e.hov=false;e.w=0;e.h=0;e.idx=idx;
  w.querySelector('.rb').addEventListener('click',ev=>{ev.stopPropagation();resetExp(e)});
  w.querySelector('.sb').addEventListener('click',ev=>{
    ev.stopPropagation();
    if(soloIdx===idx){
      // unsolo – move back to grid
      soloIdx=-1;
      w.classList.remove('solo');
      grid.appendChild(w);
      exps.forEach(x=>{x.el.classList.remove('faded')});
    }else{
      // solo – pull out of grid, go fullscreen
      if(soloIdx>=0){
        // unsolo previous
        const prev=exps[soloIdx];
        prev.el.classList.remove('solo');
        grid.appendChild(prev.el);
      }
      soloIdx=idx;
      exps.forEach((x,i)=>{x.el.classList.toggle('faded',i!==idx)});
      w.classList.add('solo');
      document.body.appendChild(w);
    }
    requestAnimationFrame(()=>exps.forEach(x=>resizeCanvas(x)));
    setTimeout(()=>exps.forEach(x=>resizeCanvas(x)),100);
  });
  const bd=w.querySelector('.body');
  bd.addEventListener('mouseenter',()=>{e.hov=true});
  bd.addEventListener('mouseleave',()=>{e.hov=false});
  w.addEventListener('dblclick',ev=>{
    flipPre();w.classList.toggle('expanded');flipGo();
    setTimeout(()=>exps.forEach(x=>resizeCanvas(x)),400);
  });
});

function resetExp(e){
  if(e.id==='butterfly'){e.s={trail:[],t:0}}
  else if(e.id==='lorenz'){e.s={x:.1,y:0,z:0,trail:[]}}
  else if(e.id==='life'){e.s={grid:null,gen:0,tick:0}}
  else if(e.id==='boids'){e.s={birds:null,food:null}}
  else if(e.id==='galaxy'){e.s={stars:null}}
  else if(e.id==='ftree'){e.s.st=-1}
  else if(e.id==='terrain'){e.s.offset=0}
  else if(e.id==='dpendulum'){e.s={a1:Math.PI*.75,a2:Math.PI*.5,v1:0,v2:0,trail:[]}}
  else if(e.s.st!==undefined)e.s.st=-1;
  if(e.cx){e.cx.fillStyle=getBg();e.cx.fillRect(0,0,e.w,e.h)}
}

// ── FLIP animation ──
let flipR=null;
function flipPre(){const ch=[...grid.children];flipR=new Map();ch.forEach(c=>flipR.set(c,c.getBoundingClientRect()))}
function flipGo(skip){
  if(!flipR)return;[...grid.children].forEach(c=>{
    if(c===skip)return;const o=flipR.get(c);if(!o)return;
    const n=c.getBoundingClientRect(),dx=o.left-n.left,dy=o.top-n.top;
    if(Math.abs(dx)<1&&Math.abs(dy)<1)return;
    c.style.transition='none';c.style.transform=`translate(${dx}px,${dy}px)`;
    requestAnimationFrame(()=>{c.style.transition='transform .3s cubic-bezier(.4,0,.2,1)';c.style.transform=''});
  });flipR=null;
}

// ── drag to reorder ──
let dS=null;
grid.addEventListener('mousedown',e=>{
  const bar=e.target.closest('.bar');if(!bar||e.target.classList.contains('dot')||e.target.closest('.bbtn'))return;
  const win=bar.closest('.win');if(!win)return;
  if(altKey){
    // detach from grid
    const r=win.getBoundingClientRect();
    win.classList.add('detached');
    win.style.left=r.left+'px';win.style.top=r.top+'px';
    win.style.width=r.width+'px';win.style.height=r.height+'px';
    document.body.appendChild(win);
    const exp=exps.find(x=>x.el===win);if(exp)setTimeout(()=>resizeCanvas(exp),50);
    return;
  }
  // clone on shift+click
  if(shiftKey){
    const srcExp=exps.find(x=>x.el===win);
    if(srcExp&&exps.filter(x=>x.id===srcExp.id).length<4){
      const clone={...srcExp,s:JSON.parse(JSON.stringify(srcExp.s)),signal:0};
      clone.idx=exps.length;exps.push(clone);
      const cw=document.createElement('div');cw.className='win';cw.dataset.id=clone.id;cw.dataset.idx=clone.idx;
      cw.innerHTML=win.innerHTML;grid.appendChild(cw);
      clone.el=cw;clone.cv=cw.querySelector('canvas');clone.cx=clone.cv.getContext('2d');clone.zoom=1;clone.hov=false;clone.w=0;clone.h=0;
      cw.querySelector('.rb').addEventListener('click',ev=>{ev.stopPropagation();resetExp(clone)});
      cw.querySelector('.sb').addEventListener('click',ev=>{
        ev.stopPropagation();const ci=clone.idx;
        if(soloIdx===ci){soloIdx=-1;exps.forEach(x=>{x.el.classList.remove('solo','faded')})}
        else{soloIdx=ci;exps.forEach((x,i)=>{x.el.classList.toggle('solo',i===ci);x.el.classList.toggle('faded',i!==ci)})}
        setTimeout(()=>exps.forEach(x=>resizeCanvas(x)),50);
      });
      const bd=cw.querySelector('.body');
      bd.addEventListener('mouseenter',()=>{clone.hov=true});
      bd.addEventListener('mouseleave',()=>{clone.hov=false});
      cw.addEventListener('dblclick',ev=>{flipPre();cw.classList.toggle('expanded');flipGo();setTimeout(()=>exps.forEach(x=>resizeCanvas(x)),400)});
      setTimeout(()=>resizeCanvas(clone),50);
    }
    return;
  }
  const r=win.getBoundingClientRect();
  const ph=document.createElement('div');ph.className='ph';
  if(win.classList.contains('expanded'))ph.classList.add('expanded');
  grid.insertBefore(ph,win);
  win.style.position='fixed';win.style.left=r.left+'px';win.style.top=r.top+'px';
  win.style.width=r.width+'px';win.style.height=r.height+'px';win.style.margin='0';
  win.classList.add('dragging');document.body.appendChild(win);
  dS={win,ph,ox:e.clientX-r.left,oy:e.clientY-r.top};e.preventDefault();
});
document.addEventListener('mousemove',e=>{
  if(!dS)return;const{win,ph,ox,oy}=dS;
  win.style.left=(e.clientX-ox)+'px';win.style.top=(e.clientY-oy)+'px';
  const items=[...grid.children].filter(c=>c.classList.contains('win')||c.classList.contains('ph'));
  const pi=items.indexOf(ph);
  for(let i=0;i<items.length;i++){
    if(items[i]===ph)continue;
    const r=items[i].getBoundingClientRect();
    if(e.clientX>r.left&&e.clientX<r.right&&e.clientY>r.top&&e.clientY<r.bottom){
      flipPre();
      if(i<pi)grid.insertBefore(ph,items[i]);else{const nx=items[i].nextSibling;nx?grid.insertBefore(ph,nx):grid.appendChild(ph)}
      flipGo(ph);break;
    }
  }
});
document.addEventListener('mouseup',()=>{
  if(!dS)return;const{win,ph}=dS;const pr=ph.getBoundingClientRect();
  win.style.transition='left .25s cubic-bezier(.4,0,.2,1),top .25s cubic-bezier(.4,0,.2,1),width .25s,height .25s';
  win.style.left=pr.left+'px';win.style.top=pr.top+'px';win.style.width=pr.width+'px';win.style.height=pr.height+'px';
  setTimeout(()=>{win.style.cssText='';win.classList.remove('dragging');grid.insertBefore(win,ph);ph.remove();exps.forEach(x=>resizeCanvas(x))},260);
  dS=null;
});

// ── keyboard ──
document.addEventListener('keydown',e=>{
  const k=e.key.toLowerCase();
  if(k===' '){e.preventDefault();paused=!paused}
  else if(k>='1'&&k<='9'){
    const idx=parseInt(k)-1;
    if(idx<exps.length){
      if(soloIdx===idx){
        exps[idx].el.classList.remove('solo');grid.appendChild(exps[idx].el);
        soloIdx=-1;exps.forEach(x=>{x.el.classList.remove('faded')});
      }else{
        if(soloIdx>=0){exps[soloIdx].el.classList.remove('solo');grid.appendChild(exps[soloIdx].el)}
        soloIdx=idx;exps.forEach((x,i)=>{x.el.classList.toggle('faded',i!==idx)});
        exps[idx].el.classList.add('solo');document.body.appendChild(exps[idx].el);
      }
      setTimeout(()=>exps.forEach(x=>resizeCanvas(x)),50);
    }
  }
  else if(k==='r'){exps.forEach(x=>resetExp(x))}
  else if(k==='g'){showGrid=!showGrid}
  else if(k==='c'){colorMode=(colorMode+1)%3}
  else if(k==='m'){mirrored=!mirrored;document.querySelectorAll('.win').forEach(w=>w.classList.toggle('mirrored',mirrored))}
  else if(k==='i'){inverted=!inverted;document.body.style.background=inverted?'#f5f5f0':'#050505'}
  else if(k==='x'&&!chaosMode){chaosMode=true;chaosEnd=performance.now()+5000}
  else if(k==='tab'){
    e.preventDefault();
    const wins=document.querySelectorAll('.win');
    const cur=[...wins].findIndex(w=>w.classList.contains('focused'));
    wins.forEach(w=>w.classList.remove('focused'));
    const next=(cur+1)%wins.length;wins[next].classList.add('focused');
    wins[next].style.borderColor='rgba(255,255,255,.3)';
  }
  lastInteract=performance.now();
});

// ── cross-window signals ──
function getNeighborSignal(idx){
  const cols=getGridCols();
  let sum=0,count=0;
  const row=Math.floor(idx/cols),col=idx%cols;
  const blend=chaosMode?1:.15;
  exps.forEach((e,i)=>{
    if(i===idx)return;
    const r2=Math.floor(i/cols),c2=i%cols;
    if(Math.abs(r2-row)<=1&&Math.abs(c2-col)<=1){sum+=e.signal*blend;count++}
  });
  return count>0?sum/count:0;
}

// ── hint visibility ──
let hintTimer=null;
function checkHint(){
  const idle=performance.now()-lastInteract>10000;
  hintEl.classList.toggle('visible',idle);
}

// ── background grid ──
function drawBg(){
  const W=innerWidth,H=innerHeight;bgX.clearRect(0,0,W,H);
  if(mx>-500){
    const h=getHue(0);
    const g=bgX.createRadialGradient(mx,my,0,mx,my,forceRadius*1.8);
    g.addColorStop(0,colorMode===0?`hsla(${h|0},30%,60%,.015)`:'rgba(255,255,255,.015)');
    g.addColorStop(1,'transparent');bgX.fillStyle=g;bgX.fillRect(0,0,W,H);
  }
  if(!showGrid)return;
  bgX.lineWidth=.5;
  const gridHue=getHue(0);
  bgX.strokeStyle=colorMode===0?`hsla(${gridHue|0},20%,50%,.015)`:'rgba(255,255,255,.015)';
  for(let gy=0;gy<=H;gy+=40){bgX.beginPath();for(let gx=0;gx<=W;gx+=4){const dx=gx-mx,dy=gy-my,d=Math.sqrt(dx*dx+dy*dy);let py=gy;if(d<forceRadius&&d>0){const f=1-d/forceRadius;py+=(dy/d)*f*f*25}gx===0?bgX.moveTo(gx,py):bgX.lineTo(gx,py)}bgX.stroke()}
  for(let gx=0;gx<=W;gx+=40){bgX.beginPath();for(let gy=0;gy<=H;gy+=4){const dx=gx-mx,dy=gy-my,d=Math.sqrt(dx*dx+dy*dy);let px=gx;if(d<forceRadius&&d>0){const f=1-d/forceRadius;px+=(dx/d)*f*f*25}gy===0?bgX.moveTo(px,gy):bgX.lineTo(px,gy)}bgX.stroke()}
}

// ── window UI reactions ──
function reactUI(){
  exps.forEach(e=>{
    if(!e.el||e.el.classList.contains('faded'))return;
    const w=e.el,r=w.getBoundingClientRect(),cx=r.left+r.width/2,cy=r.top+r.height/2;
    const d=Math.hypot(cx-mx,cy-my),mD=Math.hypot(r.width,r.height)*.7;
    const p=Math.max(0,1-d/mD);
    const hue=getHue(e.hue);
    if(colorMode===0){
      w.style.borderColor=`hsla(${hue|0},${(30+p*30)|0}%,${(50+p*20)|0}%,${(.06+p*.14).toFixed(3)})`;
      w.style.boxShadow=`0 12px 40px rgba(0,0,0,.4),0 0 ${(p*35)|0}px hsla(${hue|0},40%,60%,${(p*.04).toFixed(3)})`;
    }else{
      w.style.borderColor=`rgba(255,255,255,${(.06+p*.14).toFixed(3)})`;
      w.style.boxShadow=`0 12px 40px rgba(0,0,0,.4),0 0 ${(p*35)|0}px rgba(255,255,255,${(p*.025).toFixed(3)})`;
    }
  });
  document.querySelectorAll('.dot').forEach(dot=>{
    const r=dot.getBoundingClientRect(),cx=r.left+3.5,cy=r.top+3.5,d=Math.hypot(cx-mx,cy-my);
    if(d<50){const f=1-d/50,a=Math.atan2(cy-my,cx-mx),p=f*10;dot.style.transform=`translate(${(Math.cos(a)*p).toFixed(1)}px,${(Math.sin(a)*p).toFixed(1)}px) scale(${(1+f*.4).toFixed(2)})`;dot.style.filter=`brightness(${(1+f*.7).toFixed(1)})`}
    else{dot.style.transform='';dot.style.filter=''}
  });
}

// ── cursor overlay ──
function drawOl(){
  olX.clearRect(0,0,innerWidth,innerHeight);
  if(mx>-500){
    const hue=getHue(0);
    const dotCol=colorMode===0?`hsla(${hue|0},50%,80%,.9)`:'rgba(255,255,255,.9)';
    olX.beginPath();olX.arc(mx,my,3,0,Math.PI*2);olX.fillStyle=dotCol;olX.fill();
    const rr=forceRadius*.12+Math.min(mSpd*.5,14);
    const ringCol=colorMode===0?`hsla(${hue|0},40%,70%,${(.06+Math.min(mSpd*.007,.12)).toFixed(3)})`:`rgba(255,255,255,${(.08+Math.min(mSpd*.007,.12)).toFixed(3)})`;
    olX.beginPath();olX.arc(mx,my,rr,0,Math.PI*2);
    olX.strokeStyle=ringCol;olX.lineWidth=.8;olX.stroke();
    // force radius indicator (faint)
    if(clicking){
      olX.beginPath();olX.arc(mx,my,forceRadius,0,Math.PI*2);
      olX.strokeStyle=shiftKey?'rgba(255,80,80,.06)':'rgba(80,180,255,.06)';olX.lineWidth=.5;olX.stroke();
    }
  }
}

// ══════════════════════════════════════
// ── DRAW FUNCTIONS ──
// ══════════════════════════════════════

function drawButterfly(ctx,w,h,time,m,s,e){
  ctx.fillStyle=getBgFade(.055);ctx.fillRect(0,0,w,h);
  const nb=getNeighborSignal(e.idx);
  const cX=w/2,cY=h/2,sc=Math.min(w,h)*.17,sp=(m.in?.028:.015)*(1+nb*.5);
  for(let i=0;i<3;i++){
    s.t+=sp;const f=Math.exp(Math.cos(s.t))-2*Math.cos(4*s.t)-Math.pow(Math.sin(s.t/12),5);
    let px=cX+Math.sin(s.t)*f*sc,py=cY-Math.cos(s.t)*f*sc;
    if(m.in){const frc=applyForce(px,py,m,forceRadius);px+=frc.fx;py+=frc.fy}
    s.trail.push({x:px,y:py});
  }
  if(s.trail.length>1){
    ctx.beginPath();ctx.moveTo(s.trail[0].x,s.trail[0].y);
    for(let i=1;i<s.trail.length;i++)ctx.lineTo(s.trail[i].x,s.trail[i].y);
    ctx.strokeStyle=getCol(e.hue,.5);ctx.lineWidth=1;ctx.stroke();
    const l=s.trail[s.trail.length-1];
    ctx.beginPath();ctx.arc(l.x,l.y,3.5,0,Math.PI*2);ctx.fillStyle=getCol(e.hue,.9,60,85);ctx.fill();
    ctx.beginPath();ctx.arc(l.x,l.y,12,0,Math.PI*2);ctx.fillStyle=getCol(e.hue,.08);ctx.fill();
  }
  if(s.trail.length>600)s.trail=s.trail.slice(-600);
  e.signal=Math.min(1,s.trail.length/600);
}

function drawGolden(ctx,w,h,time,m,s,e){
  const D=14,ST=.5,HO=2,FA=.8;
  if(s.st<0)s.st=time;const el=(time-s.st)/1e3,dd=D*ST,cy=dd+HO+FA,pos=el%cy;
  const prog=Math.min(pos/ST,D);let fade=1;if(pos>dd+HO)fade=Math.max(0,1-(pos-dd-HO)/FA);
  ctx.fillStyle=getBg();ctx.fillRect(0,0,w,h);if(fade<=0)return;
  let oX=w/2,oY=h/2;if(m.in){oX+=(m.x-w/2)*.18;oY+=(m.y-h/2)*.18}
  ctx.save();ctx.translate(oX,oY);
  let sz=Math.min(w,h)*.38,x=0,y=0;const fs=Math.floor(prog),fr=prog-fs;
  for(let i=0;i<Math.min(fs+1,D);i++){
    const ic=i===fs,t=ic?fr:1,al=Math.max(.06,.45-i*.025)*fade;
    let bo=0;if(m.in){const d=Math.hypot(oX+x-m.x,oY+y-m.y);bo=Math.max(0,1-d/120)*.35}
    const a=al+bo*fade;
    const rt=Math.min(t/.35,1);
    if(rt>0){
      const rx=x-sz/2,ry=y-sz/2,pts=[[rx,ry],[rx+sz,ry],[rx+sz,ry+sz],[rx,ry+sz],[rx,ry]];
      let rem=rt*sz*4;ctx.beginPath();ctx.moveTo(pts[0][0],pts[0][1]);
      for(let ee=0;ee<4;ee++){if(rem<=0)break;const et=Math.min(rem/sz,1);ctx.lineTo(pts[ee][0]+(pts[ee+1][0]-pts[ee][0])*et,pts[ee][1]+(pts[ee+1][1]-pts[ee][1])*et);rem-=sz}
      ctx.strokeStyle=getCol(e.hue,a);ctx.lineWidth=1+bo*3;ctx.stroke();
    }
    const at=Math.max(0,(t-.35)/.65);
    if(at>0){
      const ax=x-sz/2,ay=y-sz/2,cors=[[ax+sz,ay+sz,Math.PI,Math.PI*1.5],[ax,ay+sz,Math.PI*1.5,Math.PI*2],[ax,ay,0,Math.PI*.5],[ax+sz,ay,Math.PI*.5,Math.PI]];
      const[acx,acy,a1,a2]=cors[i%4],se=a1+(a2-a1)*at;
      ctx.beginPath();ctx.arc(acx,acy,sz,a1,se);ctx.strokeStyle=getCol(e.hue+30,a*.65,50,70);ctx.lineWidth=1.2+bo*3;ctx.stroke();
    }
    const ns=sz/PHI,off=[[sz/2-ns/2,-(sz/2-ns/2)],[sz/2-ns/2,sz/2-ns/2],[-(sz/2-ns/2),sz/2-ns/2],[-(sz/2-ns/2),-(sz/2-ns/2)]];
    x+=off[i%4][0];y+=off[i%4][1];sz=ns;
  }
  ctx.restore();
  e.signal=prog/D;
}

function drawCubes(ctx,w,h,time,m,s,e){
  ctx.fillStyle=getBg();ctx.fillRect(0,0,w,h);
  const nb=getNeighborSignal(e.idx);
  const t=time*.001,gN=7,cs=Math.min(w,h)*.04,sp=Math.min(w,h)*.085;
  ctx.save();ctx.translate(w/2,h/2);
  let totalH=0;
  for(let r=-gN;r<=gN;r++)for(let c=-gN;c<=gN;c++){
    const ix=(c-r)*sp*Math.cos(A30),iy=(c+r)*sp*Math.sin(A30),dist=Math.sqrt(c*c+r*r);
    let wv=Math.sin(dist*.5-t*2+nb*3)*.5+.5,ex=0;
    if(m.in){const sx=w/2+ix,sy=h/2+iy;const frc=applyForce(sx,sy,m,forceRadius);wv+=Math.abs(frc.fy)*.02;ex=Math.max(0,1-Math.hypot(sx-m.x,sy-m.y)/forceRadius)*.15}
    const ht=wv*28+2;totalH+=ht;const al=Math.max(.2,1-dist*.07)+ex,x=ix,y=iy;
    isoF(ctx,[[x,y-ht],[x+cs*Math.cos(A30),y-ht+cs*Math.sin(A30)],[x,y-ht+cs],[x-cs*Math.cos(A30),y-ht+cs*Math.sin(A30)]],getCol(e.hue,al*.1),getCol(e.hue,al*.22));
    isoF(ctx,[[x-cs*Math.cos(A30),y-ht+cs*Math.sin(A30)],[x,y-ht+cs],[x,y+cs],[x-cs*Math.cos(A30),y+cs*Math.sin(A30)]],getCol(e.hue+15,al*.05),getCol(e.hue+15,al*.15));
    isoF(ctx,[[x+cs*Math.cos(A30),y-ht+cs*Math.sin(A30)],[x,y-ht+cs],[x,y+cs],[x+cs*Math.cos(A30),y+cs*Math.sin(A30)]],getCol(e.hue-15,al*.025),getCol(e.hue-15,al*.15));
  }
  ctx.restore();
  e.signal=totalH/((2*gN+1)*(2*gN+1)*30);
}

function drawWaves(ctx,w,h,time,m,s,e){
  ctx.fillStyle=getBg();ctx.fillRect(0,0,w,h);
  const nb=getNeighborSignal(e.idx);
  const t=time*.001,rows=15,rH=h/rows;
  let totalAmp=0;
  for(let r=0;r<rows;r++){
    const y0=rH*(r+.5),ph=r*.3+nb*2;ctx.beginPath();
    for(let x=0;x<=w;x+=2){
      const nx=x/w;let a1=rH*.25,a2=rH*.12;
      if(m.in){const frc=applyForce(x,y0,m,forceRadius);a1+=Math.abs(frc.fy)*1.2;a2+=Math.abs(frc.fx)*.8}
      const yy=y0+Math.sin(nx*8+t*2+ph)*a1+Math.sin(nx*12-t*1.5+ph*.7)*a2;
      x===0?ctx.moveTo(x,yy):ctx.lineTo(x,yy);totalAmp+=Math.abs(yy-y0);
    }
    let al=.1+.1*Math.sin(r*.4+t);if(m.in){const d=Math.abs(y0-m.y);if(d<70)al+=(1-d/70)*.25}
    ctx.strokeStyle=getCol(e.hue+r*3,al);ctx.lineWidth=1;ctx.stroke();
  }
  e.signal=Math.min(1,totalAmp/(rows*w*.1));
}

function drawLorenz(ctx,w,h,time,m,s,e){
  ctx.fillStyle=getBgFade(.04);ctx.fillRect(0,0,w,h);
  const nb=getNeighborSignal(e.idx);
  const sig=10+nb*5,rho=28,bet=8/3,dt=.005,sc=Math.min(w,h)*.012;
  for(let i=0;i<8;i++){
    s.x+=sig*(s.y-s.x)*dt;s.y+=(s.x*(rho-s.z)-s.y)*dt;s.z+=(s.x*s.y-bet*s.z)*dt;
    let px=w/2+s.x*sc,py=h-h*.12-s.z*sc*.6;
    if(m.in){const frc=applyForce(px,py,m,forceRadius);px+=frc.fx;py+=frc.fy}
    s.trail.push({x:px,y:py});
  }
  if(s.trail.length>1){
    ctx.beginPath();ctx.moveTo(s.trail[0].x,s.trail[0].y);
    for(let i=1;i<s.trail.length;i++)ctx.lineTo(s.trail[i].x,s.trail[i].y);
    ctx.strokeStyle=getCol(e.hue,.4);ctx.lineWidth=.8;ctx.stroke();
    const l=s.trail[s.trail.length-1];
    ctx.beginPath();ctx.arc(l.x,l.y,3,0,Math.PI*2);ctx.fillStyle=getCol(e.hue,.9,60,85);ctx.fill();
    ctx.beginPath();ctx.arc(l.x,l.y,10,0,Math.PI*2);ctx.fillStyle=getCol(e.hue,.06);ctx.fill();
  }
  if(s.trail.length>800)s.trail=s.trail.slice(-800);
  e.signal=Math.min(1,Math.hypot(s.x,s.y,s.z)/50);
}

function drawRose(ctx,w,h,time,m,s,e){
  const KS=[2,3,5,2/3,3/2,7/3,4,5/3],DD=5,HO=2,FA=.6;
  if(s.st<0)s.st=time;const el=(time-s.st)/1e3,cy=DD+HO+FA,pos=el%cy;
  const k=KS[Math.floor(el/cy)%KS.length],prog=Math.min(pos/DD,1);
  let fade=1;if(pos>DD+HO)fade=Math.max(0,1-(pos-DD-HO)/FA);
  ctx.fillStyle=getBg();ctx.fillRect(0,0,w,h);if(fade<=0)return;
  const cX=w/2,cY=h/2,rad=Math.min(w,h)*.38,tM=Math.PI*6,N=600,dc=Math.floor(prog*N);
  if(dc<2)return;
  ctx.beginPath();
  for(let i=0;i<=dc;i++){const th=(i/N)*tM,r=Math.cos(k*th)*rad;const x=cX+r*Math.cos(th),y=cY+r*Math.sin(th);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)}
  ctx.strokeStyle=getCol(e.hue,.5*fade);ctx.lineWidth=1;ctx.stroke();
  if(prog<1){const th=(dc/N)*tM,r=Math.cos(k*th)*rad,tx=cX+r*Math.cos(th),ty=cY+r*Math.sin(th);
    ctx.beginPath();ctx.arc(tx,ty,3,0,Math.PI*2);ctx.fillStyle=getCol(e.hue,.9*fade,60,85);ctx.fill();
    ctx.beginPath();ctx.arc(tx,ty,10,0,Math.PI*2);ctx.fillStyle=getCol(e.hue,.07*fade);ctx.fill()}
  ctx.font='9px "Fragment Mono",monospace';ctx.fillStyle=getCol(e.hue,.12*fade);
  ctx.fillText('k = '+(Number.isInteger(k)?k:k.toFixed(2)),8,h-6);
  e.signal=prog;
}

function drawPendulum(ctx,w,h,time,m,s,e){
  ctx.fillStyle=getBg();ctx.fillRect(0,0,w,h);
  const nb=getNeighborSignal(e.idx);
  const N=15,t=time*.001,pY=h*.08,mL=h*.7,sp=w/(N+1),bf=1.5+nb*.5;
  ctx.beginPath();ctx.moveTo(sp*.5,pY);ctx.lineTo(w-sp*.5,pY);ctx.strokeStyle=getCol(e.hue,.06);ctx.lineWidth=1;ctx.stroke();
  let totalE=0;
  for(let i=0;i<N;i++){
    const freq=bf+i*.08,ang=Math.sin(t*freq)*.8,len=mL-i*(mL*.015);
    const px=sp*(i+1),bx=px+Math.sin(ang)*len,by=pY+Math.cos(ang)*len;
    // cursor pumping
    let extra=0;if(m.in){const frc=applyForce(bx,by,m,forceRadius);extra=frc.fy*.003}
    const fAng=ang+extra;totalE+=Math.abs(fAng);
    const fbx=px+Math.sin(fAng)*len,fby=pY+Math.cos(fAng)*len;
    ctx.beginPath();ctx.moveTo(px,pY);ctx.lineTo(fbx,fby);ctx.strokeStyle=getCol(e.hue+i*4,.1);ctx.lineWidth=.7;ctx.stroke();
    let ba=.35;if(m.in){const d=Math.hypot(fbx-m.x,fby-m.y);if(d<60)ba+=(1-d/60)*.4}
    ctx.beginPath();ctx.arc(fbx,fby,3.5,0,Math.PI*2);ctx.fillStyle=getCol(e.hue+i*4,ba,50,70);ctx.fill();
  }
  e.signal=Math.min(1,totalE/(N*.8));
}

function drawLissajous(ctx,w,h,time,m,s,e){
  const PS=[[3,2],[3,4],[5,4],[5,6],[7,6],[3,5],[2,3],[4,5]],DD=5,HO=2,FA=.6;
  if(s.st<0)s.st=time;const el=(time-s.st)/1e3,cy=DD+HO+FA,pos=el%cy;
  const[a,b]=PS[Math.floor(el/cy)%PS.length],prog=Math.min(pos/DD,1);
  let fade=1;if(pos>DD+HO)fade=Math.max(0,1-(pos-DD-HO)/FA);
  ctx.fillStyle=getBg();ctx.fillRect(0,0,w,h);if(fade<=0)return;
  const cX=w/2,cY=h/2,amp=Math.min(w,h)*.38,N=500,dc=Math.floor(prog*N),tM=Math.PI*2;
  if(dc<2)return;
  ctx.beginPath();
  for(let i=0;i<=dc;i++){const t=(i/N)*tM;const x=cX+Math.sin(a*t+Math.PI/2)*amp,y=cY+Math.sin(b*t)*amp;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)}
  ctx.strokeStyle=getCol(e.hue,.5*fade);ctx.lineWidth=1;ctx.stroke();
  if(prog<1){const t=(dc/N)*tM,tx=cX+Math.sin(a*t+Math.PI/2)*amp,ty=cY+Math.sin(b*t)*amp;
    ctx.beginPath();ctx.arc(tx,ty,3,0,Math.PI*2);ctx.fillStyle=getCol(e.hue,.9*fade,60,85);ctx.fill()}
  ctx.font='9px "Fragment Mono",monospace';ctx.fillStyle=getCol(e.hue,.12*fade);
  ctx.fillText(a+':'+b,8,h-6);
  e.signal=prog;
}

// ── NEW: Game of Life ──
function drawLife(ctx,w,h,time,m,s,e){
  const cellSz=6,cols=Math.floor(w/cellSz),rows=Math.floor(h/cellSz);
  if(!s.grid||s.grid.length!==cols*rows){
    s.grid=new Uint8Array(cols*rows);
    for(let i=0;i<s.grid.length;i++)s.grid[i]=Math.random()<.3?1:0;
    s.gen=0;s.tick=0;s.ages=new Uint16Array(cols*rows);
  }
  // click toggles cells
  if(m.in&&m.click){
    const gc=Math.floor(m.x/cellSz),gr=Math.floor(m.y/cellSz);
    for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++){
      const rr=gr+dr,cc=gc+dc;
      if(rr>=0&&rr<rows&&cc>=0&&cc<cols)s.grid[rr*cols+cc]=1;
    }
  }
  // step every 4 frames
  s.tick++;
  if(s.tick%4===0){
    const next=new Uint8Array(cols*rows);
    let alive=0;
    for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){
      let n=0;
      for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++){
        if(dr===0&&dc===0)continue;
        const rr=(r+dr+rows)%rows,cc=(c+dc+cols)%cols;
        n+=s.grid[rr*cols+cc];
      }
      const idx=r*cols+c,was=s.grid[idx];
      if(was&&(n===2||n===3)){next[idx]=1;s.ages[idx]++}
      else if(!was&&n===3){next[idx]=1;s.ages[idx]=0}
      else{s.ages[idx]=0}
      if(next[idx])alive++;
    }
    s.grid=next;s.gen++;
    e.signal=Math.min(1,alive/(cols*rows*.3));
  }
  ctx.fillStyle=getBg();ctx.fillRect(0,0,w,h);
  for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){
    if(!s.grid[r*cols+c])continue;
    const age=Math.min(s.ages[r*cols+c],60);
    const al=.15+.6*(1-age/60);
    ctx.fillStyle=getCol(e.hue+age*2,al,50,65);
    ctx.fillRect(c*cellSz,r*cellSz,cellSz-1,cellSz-1);
  }
}

// ── NEW: Boids ──
function drawBoids(ctx,w,h,time,m,s,e){
  if(!s.birds){
    s.birds=[];for(let i=0;i<120;i++)s.birds.push({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-.5)*2,vy:(Math.random()-.5)*2});
    s.food=null;
  }
  if(m.in&&m.click&&!m.shift)s.food={x:m.x,y:m.y,t:time};
  if(s.food&&time-s.food.t>3000)s.food=null;
  ctx.fillStyle=getBgFade(.15);ctx.fillRect(0,0,w,h);
  const nb=getNeighborSignal(e.idx);
  let avgVx=0,avgVy=0;
  for(const b of s.birds){
    let sx=0,sy=0,ax=0,ay=0,cx=0,cy=0,sn=0,an=0,cn=0;
    for(const o of s.birds){
      if(o===b)continue;
      const d=Math.hypot(o.x-b.x,o.y-b.y);
      if(d<15){sx+=b.x-o.x;sy+=b.y-o.y;sn++}
      if(d<40){ax+=o.vx;ay+=o.vy;an++}
      if(d<60){cx+=o.x;cy+=o.y;cn++}
    }
    if(sn){b.vx+=sx/sn*.05;b.vy+=sy/sn*.05}
    if(an){b.vx+=(ax/an-b.vx)*.02;b.vy+=(ay/an-b.vy)*.02}
    if(cn){b.vx+=(cx/cn-b.x)*.001;b.vy+=(cy/cn-b.y)*.001}
    // cursor = predator
    if(m.in){const d=Math.hypot(b.x-m.x,b.y-m.y);if(d<80&&d>0){b.vx+=(b.x-m.x)/d*1.5;b.vy+=(b.y-m.y)/d*1.5}}
    // food attractor
    if(s.food){const d=Math.hypot(b.x-s.food.x,b.y-s.food.y);if(d>5){b.vx+=(s.food.x-b.x)/d*.3;b.vy+=(s.food.y-b.y)/d*.3}}
    // neighbor chaos
    b.vx+=(Math.random()-.5)*nb*.5;b.vy+=(Math.random()-.5)*nb*.5;
    const spd=Math.hypot(b.vx,b.vy),maxS=3+nb*2;
    if(spd>maxS){b.vx=b.vx/spd*maxS;b.vy=b.vy/spd*maxS}
    b.x+=b.vx;b.y+=b.vy;
    if(b.x<0)b.x+=w;if(b.x>w)b.x-=w;if(b.y<0)b.y+=h;if(b.y>h)b.y-=h;
    avgVx+=Math.abs(b.vx);avgVy+=Math.abs(b.vy);
    const ang=Math.atan2(b.vy,b.vx);
    ctx.save();ctx.translate(b.x,b.y);ctx.rotate(ang);
    ctx.beginPath();ctx.moveTo(4,0);ctx.lineTo(-2,1.5);ctx.lineTo(-2,-1.5);ctx.closePath();
    ctx.fillStyle=getCol(e.hue+ang*20,.4,50,70);ctx.fill();
    ctx.restore();
  }
  if(s.food){ctx.beginPath();ctx.arc(s.food.x,s.food.y,4,0,Math.PI*2);ctx.fillStyle=getCol(e.hue+120,.5,60,75);ctx.fill()}
  e.signal=Math.min(1,(avgVx+avgVy)/(s.birds.length*4));
}

// ── NEW: Galaxy ──
function drawGalaxy(ctx,w,h,time,m,s,e){
  if(!s.stars){
    s.stars=[];
    for(let i=0;i<500;i++){
      const r=Math.random()*Math.min(w,h)*.4+5;
      const a=Math.random()*Math.PI*2;
      const spd=.3/Math.sqrt(r*.01+.5);
      s.stars.push({r,a,spd,x:0,y:0,px:0,py:0});
    }
  }
  ctx.fillStyle=getBgFade(.08);ctx.fillRect(0,0,w,h);
  const cx=w/2,cy=h/2;let totalAM=0;
  for(const st of s.stars){
    st.a+=st.spd*.01;
    st.px=st.x;st.py=st.y;
    st.x=cx+Math.cos(st.a)*st.r;st.y=cy+Math.sin(st.a)*st.r;
    // cursor gravity well
    if(m.in){
      const dx=m.x-st.x,dy=m.y-st.y,d=Math.hypot(dx,dy);
      if(d<100&&d>5){const f=(1-d/100)*.8;st.x+=dx/d*f;st.y+=dy/d*f}
    }
    const v=Math.hypot(st.x-st.px,st.y-st.py);totalAM+=v*st.r;
    const vNorm=Math.min(1,v/3);
    ctx.beginPath();ctx.arc(st.x,st.y,1+vNorm,0,Math.PI*2);
    ctx.fillStyle=getCol(e.hue-vNorm*60,.3+vNorm*.5,40+vNorm*30,55+vNorm*30);ctx.fill();
    if(v>.5){
      ctx.beginPath();ctx.moveTo(st.px,st.py);ctx.lineTo(st.x,st.y);
      ctx.strokeStyle=getCol(e.hue,.08);ctx.lineWidth=.5;ctx.stroke();
    }
  }
  // central glow
  const g=ctx.createRadialGradient(cx,cy,0,cx,cy,20);
  g.addColorStop(0,getCol(e.hue,.15,60,80));g.addColorStop(1,'transparent');
  ctx.fillStyle=g;ctx.fillRect(cx-20,cy-20,40,40);
  e.signal=Math.min(1,totalAM/(s.stars.length*50));
}

// ── NEW: Fractal Tree ──
function drawFractalTree(ctx,w,h,time,m,s,e){
  const DD=4,HO=2,FA=.6,maxD=12;
  if(s.st<0)s.st=time;
  const el=(time-s.st)/1e3,cy=DD+HO+FA,pos=el%cy;
  const prog=Math.min(pos/DD,1);
  let fade=1;if(pos>DD+HO)fade=Math.max(0,1-(pos-DD-HO)/FA);
  ctx.fillStyle=getBg();ctx.fillRect(0,0,w,h);
  if(fade<=0)return;
  const nb=getNeighborSignal(e.idx);
  const depthShow=Math.floor(prog*maxD);
  const baseLen=Math.min(w,h)*.18;
  const baseAng=-Math.PI/2;
  // cursor bends branches
  const bendX=m.in?(m.x/w-.5)*.4:0;
  const bendY=m.in?(m.y/h-.5)*.15:0;
  const spread=.45+nb*.15+Math.sin(time*.0005)*.05;
  let totalBranches=0;
  function branch(x,y,ang,len,depth){
    if(depth>depthShow||len<1.5)return;
    totalBranches++;
    const bend=bendX*depth*.08;
    const ex=x+Math.cos(ang+bend)*len;
    const ey=y+Math.sin(ang+bend+bendY*.1)*len;
    const al=(.5-depth*.03)*fade;
    const thick=Math.max(.3,(1-depth/maxD)*3);
    ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(ex,ey);
    ctx.strokeStyle=getCol(e.hue+depth*12,al,40+depth*3,50+depth*3);
    ctx.lineWidth=thick;ctx.stroke();
    // glow tip on newest depth
    if(depth===depthShow&&prog<1){
      ctx.beginPath();ctx.arc(ex,ey,2,0,Math.PI*2);
      ctx.fillStyle=getCol(e.hue,.7*fade,60,80);ctx.fill();
    }
    const nl=len*.68;
    branch(ex,ey,ang-spread,nl,depth+1);
    branch(ex,ey,ang+spread,nl,depth+1);
  }
  branch(w/2,h*.85,baseAng,baseLen,0);
  e.signal=Math.min(1,totalBranches/500);
}

// ── NEW: Perlin Terrain ──
function drawTerrain(ctx,w,h,time,m,s,e){
  if(!s.perm){
    s.perm=[];const p=[];for(let i=0;i<256;i++)p[i]=i;
    for(let i=255;i>0;i--){const j=Math.floor(Math.random()*(i+1));[p[i],p[j]]=[p[j],p[i]]}
    s.perm=new Array(512);for(let i=0;i<512;i++)s.perm[i]=p[i&255];
  }
  ctx.fillStyle=getBg();ctx.fillRect(0,0,w,h);
  s.offset+=.3;
  const layers=[{scale:.008,amp:h*.35,y:h*.5,al:.4},{scale:.015,amp:h*.2,y:h*.6,al:.25},{scale:.03,amp:h*.1,y:h*.72,al:.15}];
  const nb=getNeighborSignal(e.idx);
  let totalR=0;
  layers.forEach((lay,li)=>{
    ctx.beginPath();
    for(let x=0;x<=w;x+=2){
      const nx=(x+s.offset*(li+1)*.5)*lay.scale;
      let yy=lay.y+perlin(nx,li*.5,s.perm)*lay.amp*(1+nb*.3);
      if(m.in){const d=Math.abs(x-m.x);if(d<80)yy-=(1-d/80)*30*(m.in?1:0)}
      x===0?ctx.moveTo(x,yy):ctx.lineTo(x,yy);
      totalR+=Math.abs(yy-lay.y);
    }
    ctx.lineTo(w,h);ctx.lineTo(0,h);ctx.closePath();
    ctx.fillStyle=getCol(e.hue+li*20,lay.al,35,45);ctx.fill();
    ctx.strokeStyle=getCol(e.hue+li*20,lay.al+.1,45,55);ctx.lineWidth=.8;ctx.stroke();
  });
  e.signal=Math.min(1,totalR/(w*layers.length*20));
}

function perlin(x,y,perm){
  const X=Math.floor(x)&255,Y=Math.floor(y)&255;
  const xf=x-Math.floor(x),yf=y-Math.floor(y);
  const u=xf*xf*(3-2*xf),v=yf*yf*(3-2*yf);
  const aa=perm[perm[X]+Y],ab=perm[perm[X]+Y+1],ba=perm[perm[X+1]+Y],bb=perm[perm[X+1]+Y+1];
  const g=(h,x,y)=>{const v=h&3;return(v===0?x+y:v===1?-x+y:v===2?x-y:-x-y)};
  return(1-v)*((1-u)*g(aa,xf,yf)+u*g(ba,xf-1,yf))+v*((1-u)*g(ab,xf,yf-1)+u*g(bb,xf-1,yf-1));
}

// ── NEW: Double Pendulum ──
function drawDoublePendulum(ctx,w,h,time,m,s,e){
  ctx.fillStyle=getBgFade(.06);ctx.fillRect(0,0,w,h);
  const g=9.81,m1=1,m2=1,L1=Math.min(w,h)*.22,L2=Math.min(w,h)*.22;
  const nb=getNeighborSignal(e.idx);
  // grab tip with click
  if(m.in&&m.click){
    const ox=w/2,oy=h*.25;
    const x2=ox+L1*Math.sin(s.a1)+L2*Math.sin(s.a2);
    const y2=oy+L1*Math.cos(s.a1)+L2*Math.cos(s.a2);
    const d=Math.hypot(m.x-x2,m.y-y2);
    if(d<40){
      s.a2=Math.atan2(m.x-(ox+L1*Math.sin(s.a1)),m.y-(oy+L1*Math.cos(s.a1)));
      s.v2=0;s.v1*=.9;
    }
  }
  // RK4-lite (multiple small Euler steps)
  for(let step=0;step<6;step++){
    const dt=.02;
    const {a1,a2,v1,v2}=s;
    const da=a1-a2;
    const den1=L1*(2*m1+m2-m2*Math.cos(2*da));
    const den2=L2*(2*m1+m2-m2*Math.cos(2*da));
    const acc1=(-g*(2*m1+m2)*Math.sin(a1)-m2*g*Math.sin(a1-2*a2)-2*Math.sin(da)*m2*(v2*v2*L2+v1*v1*L1*Math.cos(da)))/den1;
    const acc2=(2*Math.sin(da)*(v1*v1*L1*(m1+m2)+g*(m1+m2)*Math.cos(a1)+v2*v2*L2*m2*Math.cos(da)))/den2;
    s.v1+=acc1*dt+nb*.001;s.v2+=acc2*dt;
    s.v1*=.9999;s.v2*=.9999;
    s.a1+=s.v1*dt;s.a2+=s.v2*dt;
  }
  const ox=w/2,oy=h*.25;
  const x1=ox+L1*Math.sin(s.a1),y1=oy+L1*Math.cos(s.a1);
  const x2=x1+L2*Math.sin(s.a2),y2=y1+L2*Math.cos(s.a2);
  s.trail.push({x:x2,y:y2});
  if(s.trail.length>500)s.trail=s.trail.slice(-500);
  // draw trail
  if(s.trail.length>1){
    ctx.beginPath();ctx.moveTo(s.trail[0].x,s.trail[0].y);
    for(let i=1;i<s.trail.length;i++)ctx.lineTo(s.trail[i].x,s.trail[i].y);
    ctx.strokeStyle=getCol(e.hue,.25);ctx.lineWidth=.8;ctx.stroke();
  }
  // draw arms
  ctx.beginPath();ctx.moveTo(ox,oy);ctx.lineTo(x1,y1);ctx.lineTo(x2,y2);
  ctx.strokeStyle=getCol(e.hue,.5,50,70);ctx.lineWidth=1.5;ctx.stroke();
  // joints
  ctx.beginPath();ctx.arc(ox,oy,3,0,Math.PI*2);ctx.fillStyle=getCol(e.hue,.3);ctx.fill();
  ctx.beginPath();ctx.arc(x1,y1,4,0,Math.PI*2);ctx.fillStyle=getCol(e.hue,.6,55,70);ctx.fill();
  ctx.beginPath();ctx.arc(x2,y2,5,0,Math.PI*2);ctx.fillStyle=getCol(e.hue,.9,60,80);ctx.fill();
  ctx.beginPath();ctx.arc(x2,y2,14,0,Math.PI*2);ctx.fillStyle=getCol(e.hue,.06);ctx.fill();
  e.signal=Math.min(1,(Math.abs(s.v1)+Math.abs(s.v2))/10);
}

// ── connecting lines between adjacent windows ──
function drawConnections(){
  const W=innerWidth,H=innerHeight;cnX.clearRect(0,0,W,H);
  const cols=getGridCols();
  exps.forEach((e,i)=>{
    if(!e.el||e.el.classList.contains('faded'))return;
    const r1=e.el.getBoundingClientRect();
    // check right neighbor and below neighbor
    const row=Math.floor(i/cols),col=i%cols;
    [[i+1,col+1<cols],[i+cols,row+1<Math.ceil(exps.length/cols)]].forEach(([ni,valid])=>{
      if(!valid||ni>=exps.length)return;
      const nb=exps[ni];if(!nb.el||nb.el.classList.contains('faded'))return;
      const r2=nb.el.getBoundingClientRect();
      const sig=(e.signal+nb.signal)/2;
      const blend=chaosMode?.6:sig*.2;
      if(blend<.01)return;
      const x1=r1.left+r1.width/2,y1=r1.top+r1.height/2;
      const x2=r2.left+r2.width/2,y2=r2.top+r2.height/2;
      // find edge points (border to border)
      const ax=r1.right<r2.left?r1.right:r1.left+r1.width/2;
      const ay=r1.bottom<r2.top?r1.bottom:r1.top+r1.height/2;
      const bx=r2.left>r1.right?r2.left:r2.left+r2.width/2;
      const by=r2.top>r1.bottom?r2.top:r2.top+r2.height/2;
      const hue1=getHue(e.hue),hue2=getHue(nb.hue);
      const midH=(hue1+hue2)/2;
      cnX.beginPath();cnX.moveTo(ax,ay);cnX.lineTo(bx,by);
      const pulse=.5+.5*Math.sin(globalTime*.003+i);
      cnX.strokeStyle=colorMode===0?`hsla(${midH|0},30%,50%,${(blend*pulse*.3).toFixed(3)})`:`rgba(255,255,255,${(blend*pulse*.08).toFixed(3)})`;
      cnX.lineWidth=.5+sig;cnX.stroke();
    });
  });
}

function getGridCols(){
  const w=innerWidth;
  if(w<=500)return 1;if(w<=800)return 2;if(w<=1200)return 3;return 4;
}

// ── clock ──
const clk=document.getElementById('clock');
function tick(){const d=new Date();clk.textContent=d.toLocaleTimeString('en-US',{hour12:false})+'.'+String(d.getMilliseconds()).padStart(3,'0')}

// ── main loop ──
resizeGlobal();
const ro=new ResizeObserver(()=>exps.forEach(e=>resizeCanvas(e)));
document.querySelectorAll('.body').forEach(b=>ro.observe(b));

function loop(t){
  if(prevT===0)prevT=t;
  const dt=(t-prevT)*timeScale;prevT=t;
  if(!paused)globalTime+=dt;
  if(chaosMode&&performance.now()>chaosEnd)chaosMode=false;

  drawBg();drawConnections();reactUI();checkHint();
  exps.forEach(e=>{
    if(!e.w||!e.h)return;
    if(paused)return;
    const z=getZoom(e);
    const vw=e.w/z,vh=e.h/z;
    e.cx.save();
    e.cx.scale(z,z);
    e.draw(e.cx,vw,vh,globalTime,lm(e),e.s,e);
    e.cx.restore();
  });
  drawOl();tick();requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
